# CI Workflow: Security scanning (vulnerabilities + secrets)
name: Security

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  security-events: write  # For SARIF upload to GitHub Security tab

jobs:
  # ================================================================
  # GRYPE â€” vulnerability scanning of Go dependencies
  # ================================================================
  grype-go-client:
    name: "Grype â€” go_client dependencies"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Grype on go_client
        uses: anchore/scan-action@v6
        id: grype
        with:
          path: go_client/
          fail-build: false
          severity-cutoff: high
          output-format: sarif

      - name: Upload Grype SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: ${{ steps.grype.outputs.sarif }}
          category: grype-go-client

      - name: Upload Grype report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grype-go-client-report
          path: ${{ steps.grype.outputs.sarif }}
          retention-days: 30

  # ================================================================
  # TRUFFLEHOG â€” secret detection in code and git history
  # ================================================================
  trufflehog:
    name: "TruffleHog â€” secret detection"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for scanning commits

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified --results=verified,unknown

  # ================================================================
  # SUMMARY
  # ================================================================
  security-summary:
    name: "Security Summary"
    runs-on: ubuntu-latest
    needs: [grype-go-client, trufflehog]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Grype (go_client vulnerabilities) | ${{ needs.grype-go-client.result == 'success' && 'âœ… Clean' || 'âš ï¸ Issues found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TruffleHog (secrets) | ${{ needs.trufflehog.result == 'success' && 'âœ… Clean' || 'ðŸš¨ Secrets detected!' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Results also available in the **Security** tab (if GitHub Advanced Security is enabled)." >> $GITHUB_STEP_SUMMARY
