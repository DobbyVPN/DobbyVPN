name: Release

# Configures this workflow to run every time a change is pushed to the main branch.
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  libs_build:
    uses: ./.github/workflows/libs_generate.yml
    secrets: inherit

  android_build:
    needs: libs_build
    uses: ./.github/workflows/android_build.yml
    secrets: inherit

  ios_build:
    needs: libs_build
    uses: ./.github/workflows/ios_build.yml
    secrets: inherit

  desktop_build:
    needs: libs_build
    uses: ./.github/workflows/desktop_build.yml
    secrets: inherit

  installers_build:
    needs: desktop_build
    uses: ./.github/workflows/installers_build.yml
    secrets: inherit

  release:
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    needs: [installers_build, android_build, ios_build]
    permissions: write-all
    env:
      APP_MAJOR_VERSION: ${{ vars.MAJOR }}
      APP_MINOR_VERSION: ${{ vars.MINOR }}
      APP_MAINTENANCE_VERSION: ${{ vars.MAINTENANCE }}

    steps:
      - uses: actions/checkout@v4

      - name: Make release dir
        run: mkdir release

      - name: Download Linux deb client
        uses: actions/download-artifact@v4
        with:
          name: dobbyVPN-linux.deb
          path: release

      - name: Download Windows x86 MSI client
        uses: actions/download-artifact@v4
        with:
          name: dobbyVPN-windows-x86.msi
          path: release

      - name: Download Windows amd64 MSI client
        uses: actions/download-artifact@v4
        with:
          name: dobbyVPN-windows-amd64.msi
          path: release

      - name: Download Windows arm64 MSI client
        uses: actions/download-artifact@v4
        with:
          name: dobbyVPN-windows-arm64.msi
          path: release

      - name: Download macos amd64 client
        uses: actions/download-artifact@v4
        with:
          name: dobbyVPN-macos-amd64.pkg
          path: release

      - name: Download macos aarch64 client
        uses: actions/download-artifact@v4
        with:
          name: dobbyVPN-macos-aarch64.pkg
          path: release

      - name: Download Android client (signed)
        uses: actions/download-artifact@v4
        with:
          name: dobbyvpn-android-sign.apk
          path: release

      - name: Download Android client (unsigned)
        uses: actions/download-artifact@v4
        with:
          name: dobbyvpn-android-unsign.apk
          path: release

      - name: Create version file for F-Droid
        run: |
          VERSION_NAME="${APP_MAJOR_VERSION}.${APP_MINOR_VERSION}.${APP_MAINTENANCE_VERSION}"
          VERSION_CODE=$((APP_MAJOR_VERSION * 1000000 + APP_MINOR_VERSION * 1000 + APP_MAINTENANCE_VERSION))
          {
            echo "versionName=${VERSION_NAME}"
            echo "versionCode=${VERSION_CODE}"
          } > release/version.txt

      - name: Compute tag
        id: tag
        run: |
          TAG="v${APP_MAJOR_VERSION}.${APP_MINOR_VERSION}.${APP_MAINTENANCE_VERSION}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update MAINTENANCE variable
        run: |
          CUR=${{ vars.MAINTENANCE }}
          NEXT=$((CUR + 1))
          echo "Current maintenance: $CUR, next: $NEXT"
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/variables/MAINTENANCE \
            -f value="$NEXT"
        env:
          GH_TOKEN: ${{ secrets.DobbyVPN_MAINTENANCE }}
